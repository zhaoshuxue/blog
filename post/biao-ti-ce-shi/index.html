<html>
<head>
    <meta charset="utf-8"/>
<meta name="description" content=""/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>使用Nginx解决VUE本地开发调用外部接口跨域的问题 | 学无止境的博客</title>

<link rel="shortcut icon" href="https://blog.funimg.top/favicon.ico?v=1621911132573">

<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://blog.funimg.top/styles/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css">

<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets/highlight.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dockerfile.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dart.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/moment@2.27.0/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.min.js"></script>
<!-- DEMO JS -->
<!--<script src="media/scripts/index.js"></script>-->



    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.css">
</head>
<body>
<div class="main gt-bg-theme-color-first">
    <nav class="navbar navbar-expand-lg">
    <div class="navbar-brand">
        <img class="user-avatar" src="/images/avatar.png" alt="头像">
        <div class="site-name gt-c-content-color-first">
            学无止境的博客
        </div>
    </div>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <i class="fas fa-bars gt-c-content-color-first" style="font-size: 18px"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <div class="navbar-nav mr-auto" style="text-align: center">
            
                <div class="nav-item">
                    
                        <a href="https://blog.funimg.top" class="menu gt-a-link">
                            首页
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="https://blog.funimg.top/archives" class="menu gt-a-link">
                            归档
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="https://blog.funimg.top/tags" class="menu gt-a-link">
                            标签
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="https://blog.funimg.top/post/about" class="menu gt-a-link">
                            关于
                        </a>
                    
                </div>
            
        </div>
        <div style="text-align: center">
            <form id="gridea-search-form" style="position: relative" data-update="1621911132573" action="/search/index.html">
                <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="搜索文章" />
                <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
        </div>
    </div>
</nav>

    <div class="post-container">
        <div class="post-detail gt-bg-theme-color-second">
            <article class="gt-post-content">
                <h2 class="post-title">
                    使用Nginx解决VUE本地开发调用外部接口跨域的问题
                </h2>
                <div class="post-info">
                    <time class="post-time gt-c-content-color-first">
                        · 2020-12-06 ·
                    </time>
                    
                        <a href="https://blog.funimg.top/tag/0TTlcbs0Q/" class="post-tags">
                            # vue
                        </a>
                    
                </div>
                <div class="post-content">
                    <p>前端开发需要调用后台接口时经常遇到跨域的问题，一般是设置Chrome浏览器禁用安全模式，<br>
在启动chrome命令后面加 <code>--disable-web-security</code>，最新的版本可能还需要加一个本地的存放chrome配置的文件夹，如下，<br>
<code>--user-data-dir=C:\MyChromeDevUserData</code></p>
<p>这种方式很不错，唯一的缺点就是有时候如果不是这种方式打开的Chrome，页面要进行跨域调试时需要关闭浏览器再用上边那种方式打开才行，这时如果已经打开了一堆网页可能就比较麻烦了。</p>
<hr>
<p>现在介绍使用Nginx的方向代理机制来解决浏览器跨域的问题</p>
<p>首先假设前端VUE的端口是8080， 要调用的后台接口是：http://192.168.1.111:9090/mydemo/api/getList</p>
<p>因为浏览器的同源策略，所以这样必然产生了跨域。</p>
<p>由于VUE已经占用了前端的端口8080了，所以我们用Nginx只能再设置一个新的端口，这里暂定：8888</p>
<p>在nginx.conf文件 http{} 块里，添加下面的代码：</p>
<pre><code>    server {
        listen  8888;
        server_name  localhost;

        location ^~/mydemo/ {
            rewrite ^/(.*)$ /$1 break;
            proxy_pass http://192.168.1.111:9090/mydemo/;
        }

        location / {
            proxy_pass http://127.0.0.1:8080;
        }
    }
</code></pre>
<h3 id="location-~mydemo-一定要放在-location-前面这样所有访问后台的请求才会走这块的代理-一般后台服务都会带着项目名例如mydemo或者加上固定的url路径前缀主要是为了跟前端静态资源区分开来"><code>location ^~/mydemo/</code> 一定要放在 <code>location /</code> 前面，这样所有访问后台的请求才会走这块的代理。 一般后台服务都会带着项目名，例如<code>mydemo</code>，或者加上固定的url路径前缀，主要是为了跟前端静态资源区分开来。</h3>
<p>重启Nginx，访问 http://localhost:8888 即可。<br>
这样就完全避免了跨域的问题，而且不限于Chrome了，使用IE、Firefox同样没有问题。</p>
<h1 id="下面提供一种新的解决方式">下面提供一种新的解决方式</h1>
<h2 id="什么是跨域">什么是跨域</h2>
<p>跨域，是指浏览器不能执行其他网站的脚本。它是由浏览器的同源策略造成的，是浏览器对JavaScript实施的安全限制。</p>
<h2 id="那么什么是同源策略">那么什么是同源策略</h2>
<p>同源策略/SOP（Same origin policy）是一种约定，由Netscape公司1995年引入浏览器，它是浏览器最核心也最基本的安全功能，如果缺少了同源策略，浏览器很容易受到XSS、CSFR等攻击。所谓同源是指&quot;协议+域名+端口&quot;三者相同，即便两个不同的域名指向同一个ip地址，也非同源。</p>
<p>下面列出了一些常见跨域场景</p>
<p>URL                                      说明                    是否允许通信<br>
http://www.google.com/a.js<br>
http://www.google.com/b.js         同一域名，不同文件或路径           允许<br>
http://www.google.com/lab/c.js</p>
<p>http://www.google.com:8000/a.js<br>
http://www.google.com/b.js         同一域名，不同端口                不允许</p>
<p>http://www.google.com/a.js<br>
https://www.google.com/b.js        同一域名，不同协议                不允许</p>
<p>http://www.google.com/a.js<br>
http://192.168.1.111/b.js           域名和域名对应相同ip              不允许</p>
<p>http://www.google.com/a.js<br>
http://x.google.com/b.js           主域相同，子域不同                不允许<br>
http://google.com/c.js</p>
<p>http://www.domain1.com/a.js<br>
http://www.domain2.com/b.js        不同域名                         不允许</p>
<p>针对跨域，目前有很多解决方案</p>
<p>1、 通过jsonp跨域<br>
2、 document.domain + iframe跨域<br>
3、 location.hash + iframe<br>
4、 window.name + iframe跨域<br>
5、 postMessage跨域<br>
6、 跨域资源共享（CORS）<br>
7、 nginx代理跨域<br>
8、 nodejs中间件代理跨域<br>
9、 WebSocket协议跨域</p>
<p>下面我们就介绍一种目前主流的跨域解决方案——跨域资源共享（CORS）</p>
<h2 id="什么是cors">什么是CORS</h2>
<p>CORS是一个W3C标准，全称是&quot;跨域资源共享&quot;（Cross-origin resource sharing）。 它允许浏览器向跨源服务器，发出XMLHttpRequest请求，从而克服了AJAX只能同源使用的限制。<br>
CORS需要浏览器和服务器同时支持。目前，所有浏览器都支持该功能，IE浏览器不能低于IE10。IE8+：IE8/9需要使用XDomainRequest对象来支持CORS。<br>
整个CORS通信过程，都是浏览器自动完成，不需要用户参与。对于开发者来说，CORS通信与同源的AJAX通信没有差别，代码完全一样。浏览器一旦发现AJAX请求跨源，就会自动添加一些附加的头信息，有时还会多出一次附加的请求，但用户不会有感觉。 因此，实现CORS通信的关键是服务器。只要服务器实现了CORS接口，就可以跨源通信。</p>
<h2 id="后端配置">后端配置</h2>
<p>只需要配置一个过滤器即可，如下：</p>
<pre><code>import org.apache.commons.lang3.StringUtils;
import org.springframework.core.annotation.Order;

import javax.servlet.*;
import javax.servlet.annotation.WebFilter;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

@WebFilter(urlPatterns = &quot;/*&quot;, filterName = &quot;corsFilter&quot;)
@Order(1)
public class CorsFilter implements Filter {

    @Override
    public void doFilter(ServletRequest req, ServletResponse resp,
                         FilterChain chain) throws IOException, ServletException {
        HttpServletResponse response = (HttpServletResponse) resp;
        HttpServletRequest request = (HttpServletRequest) req;
        // 解决跨域问题
        if (StringUtils.isNotEmpty(request.getHeader(&quot;Origin&quot;))) {
            response.setHeader(&quot;Access-Control-Allow-Origin&quot;, request.getHeader(&quot;Origin&quot;));
            response.setHeader(&quot;Access-Control-Allow-Credentials&quot;, &quot;true&quot;);
        } else {
            response.setHeader(&quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;);
        }
        response.setHeader(&quot;Access-Control-Allow-Methods&quot;, &quot;POST, GET, OPTIONS, DELETE&quot;);
        response.setHeader(&quot;Access-Control-Max-Age&quot;, &quot;36000&quot;);
        response.setHeader(&quot;Access-Control-Allow-Headers&quot;, &quot;accept,Access-Control-Request-Method,Access-Control-Request-Headers,Origin,token,x-requested-with, authorization, Content-Type, Authorization, credential, X-XSRF-TOKEN&quot;);
        response.setHeader(&quot;Access-Control-Expose-Headers&quot;, &quot;Content-Type, Authorization, credential, Content-Disposition&quot;);
        if (&quot;OPTIONS&quot;.equalsIgnoreCase(request.getMethod())) {
            response.setStatus(HttpServletResponse.SC_OK);
        } else {
            chain.doFilter(req, resp);
        }
    }

}


</code></pre>
<h2 id="前端配置">前端配置</h2>
<p>前端配置只需要把withCredentials设置为true即可。</p>
<p>1.原生ajax</p>
<pre><code>xhr.withCredentials = true;
</code></pre>
<p>2.vue框架</p>
<p>a.) axios设置：</p>
<pre><code>// 前端设置是否带cookie
axios.defaults.withCredentials = true
</code></pre>
<p>b.) vue-resource设置：</p>
<pre><code>Vue.http.options.credentials = true
</code></pre>
<p>这里假设后端服务地址为： 192.168.1.111:8080</p>
<p>我们需要配置一下hosts，（域名随便写）</p>
<pre><code>192.168.1.111 server.google.com
</code></pre>
<p>这样访问 http://server.google.com:8080 也可能访问到你的后端服务了。</p>
<p>那么前端调用后端接口需要都写成 http://server.google.com:8080/+接口 这样的方式</p>
<p>访问前端也要用这种域名加端口的方式，比如本地启动了前端项目，端口是9090，那么也需要配置一下hosts，</p>
<pre><code>127.0.0.1 front.google.com
</code></pre>
<p>就可以直接用 http://front.google.com:9090 访问前端页面了</p>
<p>也可以用下面这种配置方式直接设定vue启动后访问的url地址。</p>
<pre><code>module.exports = {
  dev: {
    host: 'front.google.com', // can be overwritten by process.env.HOST
    port: 80, // can be overwritten by process.env.PORT, if port is in use, a free one will be determined
    ...
  }
}
</code></pre>
<h2 id="总结一下">总结一下</h2>
<p>1、配置hosts</p>
<pre><code># 后端地址
192.168.1.111 server.google.com
# 前端地址
127.0.0.1 front.google.com
</code></pre>
<p>2、前端调用后端接口需要用域名+端口方式，例如 http://server.google.com:8080</p>
<p>3、在浏览器访问前端页面也需要用域名+端口的方式，例如 http://front.google.com</p>
<p>4、只要保证配置的两个域名的二级域名一样就可以了，三级域名随便。</p>
<p>5、这种方式只需要配置一次，如果想访问不同环境的后端服务，只需要修改hosts配置就可以了。而且部署前后端分离时，只需要修改前端调用后端接口的配置即可。</p>

                </div>
            </article>
        </div>

        
            <div class="next-post">
                <div class="next gt-c-content-color-first">下一篇</div>
                <a href="https://blog.funimg.top/post/zhu-da-jia-zhong-qiu-jie-guo-qing-jie-kuai-le/" class="post-title gt-a-link">
                    祝大家中秋节国庆节快乐
                </a>
            </div>
        

        

        

        

        <div class="site-footer gt-c-content-color-first">
    <div class="slogan gt-c-content-color-first">学无止境</div>
    <div class="social-container">
        
            
        
            
        
            
        
            
        
            
        
            
        
    </div>
    <div class="footer-info">
        Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
    </div>
    <div>
        Theme by <a href="https://imhanjie.com/" target="_blank">imhanjie</a>, Powered by <a
                href="https://github.com/getgridea/gridea" target="_blank">Gridea | <a href="https://blog.funimg.top/atom.xml" target="_blank">RSS</a></a>
    </div>
</div>

<script>
  hljs.initHighlightingOnLoad()
</script>

    </div>
</div>
</body>
</html>
